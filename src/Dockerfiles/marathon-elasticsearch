FROM hokiegeek2/marathon-es-cluster-base

MAINTAINER hokiegeek2@gmail.com

#
# Install Java
#
WORKDIR /deploy
RUN wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u151-b12/e758a0de34e24606bca991d704f6dcbf/jdk-8u151-linux-x64.rpm
RUN yum install -y jdk-8u151-linux-x64.rpm
  
#
# Install Elasticsearch and cleanup
#
ADD https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/zip/elasticsearch/2.3.5/elasticsearch-2.3.5.zip \
  /deploy/elasticsearch-2.3.5.zip
RUN unzip elasticsearch-2.3.5.zip
RUN ln -s /deploy/elasticsearch-2.3.5 /deploy/elasticsearch
RUN rm /deploy/elasticsearch-2.3.5.zip

#
# Configure Environment
#
EXPOSE 9200 9300
ENTRYPOINT /deploy/scripts/bootstrap-cluster.sh

#
# Install search guard
# 
ADD search-guard-2-2.3.5.11.zip /deploy/elasticsearch/bin
ADD search-guard-ssl-2.3.5.21.zip /deploy/elasticsearch/bin

RUN /deploy/elasticsearch/bin/plugin install file:///deploy/elasticsearch/bin/search-guard-2-2.3.5.11.zip
RUN /deploy/elasticsearch/bin/plugin install file:///deploy/elasticsearch/bin/search-guard-ssl-2.3.5.21.zip

#
# Provision elasticsearch user
#
RUN mkdir /data
RUN chmod 777 /data
RUN useradd -u 1206 -r elasticsearch
RUN chown -R elasticsearch:elasticsearch /deploy
RUN usermod -aG wheel elasticsearch
RUN sed -i 's/Defaults[ ]* requiretty/#Defaults      requiretty/g' /etc/sudoers
RUN echo "elasticsearch ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
USER elasticsearch
